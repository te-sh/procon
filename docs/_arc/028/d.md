---
number: '028'
problem: D
---
商品 $$ 1 \dots k_i-1 $$ から $$ c_1 $$ 個選ぶ方法の数 $$ C_1(i-1, c_1) $$ と商品 $$ k_i+1 \dots N $$ から $$ c_2 $$ 個選ぶ方法の数 $$ C_2(i+1, c_2) $$ が分かっているとすると,

$$
\sum_{c_1+c_2+x_i=M} C_1(i-1, c_1)C_2(i+1, c_2)
$$

が答えとなる.

$$ C_1 $$ は,

$$
C_1(i, j) = \sum_{k=0}^{a_i} C_1(i-1, j-k)
$$

の漸化式で DP であらかじめ求めておく. $$ C_2 $$ は $$ C_1 $$ を逆側から行えばいい.

これで部分点1, 2は取れるはずである.

さらに $$ C_1 $$ を求めるには愚直にやると $$ O(NM^2) $$ かかるが, $$ C_1(i, 0) \dots C_1(i, M) $$ の累積和を計算しておくことで $$ O(NM) $$ に収まり, 部分点3が取れるはずである.

満点を取るためには1つ目の式の計算量がこのままでは $$ O(M) $$ であり, 全体で $$ O(QM) $$ となる部分をなんとかしなければならない.

そこで $$ i $$ 以外の商品から $$ j $$ 個選ぶ方法の数 $$ D(i, j) $$ をあらかじめ計算することにする.

これには戻す DP を使う.

$$ C_1 $$ の式から,

$$
C_1(i-1, j) = C(i, j) - \sum_{k=1}^{a_i} C_1(i-1, j-k)
$$

となり, $$ i = N $$ のときは,

$$
C_1(N-1, j) = C(N, j) - \sum_{k=1}^{a_i} C_1(N-1, j-k)
$$

となる, DP は商品の順序は関係ないので, 最後に商品 $$ i $$ を見るとすると, $$ D(i, j) $$ は $$ C_1(N-1, j) $$ のことになる. よって,

$$
D(i, j) = C(N, j) - \sum_{k=1}^{a_i} D(i, j-k)
$$

となり, $$ C_1 $$ を計算するときと同様に累積和を計算することにより, $$ D(i, j) $$ は $$ O(NM) $$ で求めることができる.
